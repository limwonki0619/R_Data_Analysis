---
title: "ggplot2 Basic in R"
author: "Lim wonki"
date: '2019. 06. 18. '
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

  <br>
  
##### **모든 내용의 출처는 [coder1252님의 블로그](https://m.blog.naver.com/coder1252/220931262683)입니다.**

  <br>  

##### **목차**

  1. ggplot2 소개 <br>
      1.1 ggplot2란? <br>
      1.2 ggplot2의 핵심 - layer 추가 <br>
      1.3 레이어 추가를 통해 기본 그래프 그려보기 <br>
      <br>
      
  2. geom_bar <br>
      2.1 x축 값만 지정한 그래프 <br>
      2.2 x축, y축 값을 지정한 그래프 <br>
         2.2.1 기본 bar 그래프 <br>
         2.2.2 데이터의 종류를 한 그래프 안에 나눠서 표시해주는 bar 그래프 <br>
         2.2.3 데이터의 종류를 나눠 따로 표시해주는 bar 그래프 <br>
         2.2.4 데이터의 종류를 비율로 표시해주는 bar 그래프 <br>
         2.2.5 가로로 눕힌 bar 그래프 <br>
         2.2.6 복수의  데이터를 나란히 표현해주는 가로 그래프 <br>
         2.2.7 음수와 양수 막대 다르게 색상 입히기 <br>
         2.2.8 막대 그래프를 이용한 파이-도넛 차트 <br>
      <br>
      
  4. geom_point / jitter <br>
      <br>
      
  5. geom_line <br>
      <br>
      
  6. geom_segment <br>
      <br>
    
  7. geom_boxplot <br>
      <br>
      
  8. geom_ribbon & area <br>
      <br>
      
  9. geom_errorbar <br>
      <br>

  10. geom_treemap <br>
      <br>
      
  11. geom_bin2d <br>
      <br>
  
  <br>
  
## **1. ggplot2 소개 **  
  
  <br>
  
####  **1.1 ggplot2란?**

  R 의 데이터 시각화 패키지로서 엑셀, 파워포인트와는 다르게 함수를 입력하여 그래프를 그릴 수 있습니다. <br>
  
  <br>
  
####  **1.2 ggplot2의 핵심 - layer 추가**

  ggplot2의 장점에는 여러가지가 있습니다. 일관된 기초 문법을 가지고 있으며, 함수가 직관적이고, <br>
  그래픽 시스템의 완성도가 높습니다. 그 중 주목할 만한 장점은 레이어 추가 방식입니다. <br>
  ggplot2 함수는 기본적으로 레이어를 추가하는 방식으로 그래프를 그려나갑니다.  패션에서 레이어드 룩과 같이 <br>
  ggplot2 함수도 레이어를 추가해 가면서 그래프를 꾸미고 정보를 더해 나갈 수 있습니다. <br>
  그래프를 제거하거나 변형시키는 것도 레이어추가를 통해 할 수 있습니다. 
  
  <br>
  
####  **1.3 레이어 추가를 통해 기본 그래프 그려보기**
  
  레이어를 추가하는 방법을 중심으로  ggplot2를 통해 그래프를 그려보겠습니다. <br>
  install.packages함수로 ggplot2를 다운로드 합니다.
다운받은 패키지를 library를 통해 불러옵니다.

  <br>


```{r}
library(ggplot2)
ggplot(data=pressure, aes(x=temperature, y=pressure))
```
  
  <br>
  
  R 내장 데이터인 pressure를 통해 좌표계를 그려주었습니다.
  
```{r}
library(ggplot2)

ggplot(data=pressure, aes(x=temperature, y=pressure))+
  geom_point()+
  geom_line()
```

  <br>
  
   +geom_point()+geom_line() 를 통해 어떤 타입의 그래프를 그릴지 설정 되었습니다. 좌표계에 포인트와 <br>
   라인 그래프가 추가된 것을 확인 할 수 있습니다. <br>
   
```{r}
library(ggplot2)

ggplot(data=pressure, aes(x=temperature, y=pressure))+
  geom_point(color='orangered2', size=3)+
  geom_line(color='deepskyblue', size=2)
```
  
  <br>
  
  이전 그래프에 색을 추가해 주었습니다. geom_point뒤의 ()안에서 자유롭게 색과 사이즈 설정이 가능합니다. <br>
  그러나 이 그래프 에서는 point가 line에 가려져 잘 보이지 않습니다. 
  
  <br>
  
  point를 가리지 않기 위해 함수에서 geom_point와 geom_line의 순서를 바꿔주었습니다. <br>
  line을 먼저 그린 뒤 그 위에 point를 그려주었기 때문에 point가 더 이상 가려지지 않습니다. <br>
  ggplot2 함수의 특징인 레이어 추가 방식을 잘 보여주는 좋은 예 입니다. <br>
  
  <br><br>
  
## **2. geom_bar 그래프 그리기**  
  
  <br>
  
  bar 그래프는 아래와 같이 우리가 익숙히 알고 있는 막대그래프 입니다. <br>
  이번 에는 ggplot2 패키지로 bar 그래프를 그리는 방법에 대해 알아보겠습니다. <br>
  
  <br>
  
  ggplot에서 bar 그래프를 그리는 방식에는 크게 두 가지가 있습니다. <br><br>

  첫째, x축의 값만 지정하여 빈도를 나타내는 그래프 <br>
  둘째, x축과 y축의 값을 각각 지정하여 그리는 그래프 <br>

  R의 base data인 sleep 과 ggplot2의 package data인 diamonds를 활용하여 각각의 그래프를 그려보도록 하겠습니다. <br>
  
  <br>
  
####  **2.1 x축 값만 지정한 그래프**

```{r}
library(ggplot2)
ggplot(diamonds, aes(cut))+
  geom_bar()
```
  
  x축 값을 지정하지 않으면 ggplot은 자동적으로  x축 데이터의 '빈도'를 y값으로 나타내줍니다. <br>
  즉, diamonds 자료의 cut이란 칼럼 안에 존재하는 데이터들(Fair, Good, ..)의 빈도를 계산하여 y축에 'count'로 나타내 준 것입니다. <br>

  aes()안에는 x축 값만 입력하고, geom_bar()에 stat을 설정해주지 않습니다. <br>
  사실 빈도수가 계산되도록 하기 위해선 geom_bar()에 stat='count'를 입력해주어야 합니다. <br>
  stat='count'는 y축의 높이를 데이터의 빈도(count)로 표시하는 bar그래프 형식으로 나타내라는 뜻입니다. <br>

  하지만 이를 지정하지 않고도 자동으로 y축의 값이 빈도로 표시되는 이유는, stat='count'가 bar그래프의 default 값이기 때문입니다. <br>
  default 값이란 미리 정해져 있는 값이나 설정치를 의미하며, 특정한 값이나 설정치를 지정되지 않았을 때 이 defaut(디폴트)값을 사용합니다. <br>
  즉, geom_bar함수에서는 stat='count'가 default 값으로 설정되어 있어 따로 지정하지 않아도 자동적으로 stat='count'의 형태가 적용된 것입니다. <br>
  
  <br>
  
#### **2.2 x축, y축 값을 지정한 그래프**

#####  **2.2.1 기본 bar 그래프**
  
```{r}
library(ggplot2)
ggplot(sleep, aes(ID, extra))+
  geom_bar(stat='identity')
```
  
  그래프를 그리기 위한 코드는 크게 두 부분으로 구성돼있습니다. 데이터를 바탕으로 그래프의 틀을 정해주는 ggplot과, 그래프의 형태를 정해주는 함수입니다. 그래프의 형태를 지정해주는 부분은 앞서 말한 레이어 추가 방식(+)을 통해 계속해서 지정해줄 수 있습니다. <br>
  
  가장 먼저 자료명을 입력하여 ggplot을 통해 그릴 그래프가 어떤 자료의 데이터를 기반으로 그릴 것인지를 정해줍니다. <br>
  aes는 지정한 자료의 데이터를 바탕으로 그래프의 틀을 정해주는 함수입니다. 따라서 aes에서 데이터를 기반으로 하는 x축과 y축, 데이터 색상을 지정해줍니다. <br>

  그래프의 틀을 지정해주었으면 어떤 형식으로 그릴 것인지 정해주어야 합니다. <br>
  bar그래프는 geom_bar()로 그릴 수 있습니다. 여기서 주의해야 할 점은 geom_bar() 안에 반드시 stat='identity'를 입력해주어야 한다는 것입니다. <br>
  stat은 ‘통계’의 뜻을 가진 ‘Statistic’의 약자로, bar 그래프의 형태에 대해 지정해줍니다. <br>
  identity는 y축 값의 높이를 데이터를 기반으로 정해줄 때 사용해줍니다. 즉, stat='identity'는 y축의 높이를 데이터의 값으로 하는 bar그래프의 형태로 지정한다는 것입니다. <br>

  <br>

#####  **2.2.2 데이터의 종류를 한 그래프 안에 나눠서 표시해주는 bar 그래프**

```{r}
library(ggplot2)
ggplot(sleep, aes(ID, extra, fill=group))+
  geom_bar(stat='identity') 
```
  
   이 그래프는 같은 ID내 존재하는 복수의 데이터, 즉 group을 색상으로 구분하여 표현하고, 범례에도 나타내고 있습니다. <br>
   이전의 그래프와 차이가 있다면, aes(ID, extra)에 fill=group이 추가된 것입니다. aes는 자료의 데이터를 기반으로 한 그래프틀을 정해줄 때 사용하는 함수이고, group은 sleep 자료 내 데이터입니다. <br>
   따라서 fill함수를 aes안에 써줌으로써 sleep내 데이터인 group에 색상이 지정된 것입니다.
   <br>
   
   <br>
  
#####  **2.2.3 데이터의 종류를 한 그래프 안에 나눠서 표시해주는 bar 그래프**
  
```{r}
library(ggplot2)
ggplot(sleep, aes(ID, extra, fill=group))+
    geom_bar(stat='identity', position = 'dodge')
```
  
  이 그래프는 group데이터를 두 개의 독립적인 막대로 제시하고 있습니다. <br>
  geom_bar()에 position = 'dodge' 함수를 더해주면 됩니다. <br>
  <br>

  position은 막대의 위치를 의미합니다. dodge는 복수의 데이터를 독립적인 막대 그래프로 나란히 표현할 때 사용합니다. <br>
  즉, position='dodge'는 막대의 위치를 개별적인 막대로 나란히 표현하라는 명령어인 것입니다. <br>
  단, 나란히 표시할 막대의 데이터를 fill 혹은 color 함수를 이용해 반드시 구분지어주어야 합니다. <br>
  
  <br>
  
#####  **2.2.4 데이터의 종류룰 비율로 표시해주는 bar 그래프**
  
```{r}
library(ggplot2)
ggplot(diamonds, aes(color, fill=cut))+
    geom_bar(position='fill')
```
  
  position='fill'은 말 그대로 막대 그래프를 화면에 꽉 채워,  x값 내의 데이터의 상대적인 비율을 나타내줄 때 씁니다. <br>
  <br>

  위 그래프는 diamonds 자료에서 다이아몬드의 색상(color)에 따른 컷팅(cut)상태의 비율을 나타낸 그래프입니다. D색상의 다이아몬드는 Ideal상태로 컷팅 된 비율이 가장 높음을 알 수 있습니다. <br>
  
  <br>
  
#####  **2.2.5 가로 그래프**

```{r}
library(ggplot2)
ggplot(sleep, aes(ID, extra, fill=group))+
    geom_bar(stat='identity')+
    coord_flip() 
```

  coord는 'coordinate'의 약자로 조정하고 꾸미는 것을 의미하며, flip은 '뒤집다'의 뜻을 가지고 있습니다. 즉, coord_flip()은 x축과 y축의 구성을 뒤집어 표현하라는 명령어이며,  x축과 y축의 위치가 바뀜과 동시에 가로의 막대로 값을 표현하는 bar그래프가 그려지도록 해줍니다. <br>
  <br>
  
  coord_flip은 데이터를 기반으로 하지 않고, bar그래프에 대한 함수도 아니기 때문에 ggplot과 geom_bar 함수 뒤에 레이어 추가 형식으로 지정해 줍니다. <br>
  
  <br>
  
##### **2.2.6 복수의 데이터를 나란히 표현해주는 가로그래프**

```{r}
library(ggplot2)
ggplot(sleep, aes(ID, extra, fill=group))+
    geom_bar(stat='identity', position = 'dodge')+
  coord_flip()
```

  position='dodge' 함수와 coord_flip함수를 동시에 적용한 그래프입니다. 이렇게 ggplot은 그래프의 형태를 레이어 추가 방식을 통해 복수의 명령을 간편하게 지정할 수 있습니다. <br>
  단, position은 한 가지만 설정할 수 있습니다. position='dodge', position=fill 은 불가능합니다. <br>
  <br>

##### **2.2.7 음수와 양수 막대 다르게 색상 입히기**
  데이터 준비 :  gcookbook 패키지의 데이터 <br> 

```{r}
library(gcookbook)
csub <- subset(climate, Source == "Berkeley" & Year >= 1900)
csub$pos <- csub$Anomaly10y >= 0
ggplot(csub, aes(x = Year, y = Anomaly10y, fill = pos)) +
  geom_col()
```

  <br>

  scale_fill_manual() 을 사용해 색깔을 바꾸고, guide=FALSE 로 범례를 지운 그래프 입니다. <br>

```{r}
ggplot(csub, aes(x = Year, y = Anomaly10y, fill = pos)) +
  geom_col(colour = "black", size = .25) +
  scale_fill_manual(values = c("#CCEEFF", "#FFDDDD"), guide = FALSE)
```

##### **2.2.8 막대 그래프를 이용한 파이-도넛 차트**
  일반적으로 파이그래프는 자료를 표현하는데 있어 그리 좋은 방법은 아닌 것으로 알려져 있다. <br>
  특히 자료의 갯수가 많아 질 경우 파이 그래프보다 도넛 그래프가 더 좋은 것으로 알려져 있다. <br>
  이번 목표는 파이그래프와 donut plot을 결합하여 보기 좋은 그래프를 만드는 것이다.    
  다음과 같은 자료가 있다고 하자. <br> 
  
```{r}
data <- data.frame(browser = c("MSIE","MSIE","MSIE","MSIE","Firefox","Firefox","Firefox","Chrome","Safari","Safari","Opera"),
                   version = c("MSIE 6.0","MSIE 7.0","MSIE 8.0","MSIE 9.0","Firefox 3.5","Firefox 3.6","Firefox 4.0","Chrome 10.0","Safari 4.0","Safari 5.0","Opera 11.x"),
                   share = c(10.35, 7.35, 33.06, 2.81, 1.58, 13.12, 5.43, 9.91, 1.42, 4.55, 1.65))
```

  먼저 Pie plot과 Donut plot을 비교해보자. ggplot2의 geom_rect()및 coord_polar()를 이용하면 간단하게 파이차트와 도넛차트를 그릴 수 있다. <br>  
  geom_rect()를 이용하려면 ymin, ymax, xmin, xmax 좌표를 지정해주어야 한다. *단, geom_bar 함수로는 불가능하다..* <br>
  
  차트를 그리기 위하여 먼저 다음과 같이 자료를 전처리한다. <br> 
  
```{r}
library(dplyr)
data1 <- data %>%
  mutate(ymax = cumsum(share),
         ymin = cumsum(share)-share,
         ypos = ymin + (share/2),
         ratio = share / sum(share) * 100)
```

  먼저 geom_rect()를 이용하여 막대그래프를 만들어보자. <br> 

```{r}
p <- ggplot(data1)+
  geom_rect(aes(xmin=3,xmax=4,ymin=ymin,ymax=ymax, fill=browser, alpha=0.7))
p
```

  이제 coord_polar()를 이용하여 좌표계를 원형좌표계로 변환한다. 양궁에서 쓰이는 과녁과 비슷한 Buul’s eye plot이 그려진다. <br>
  
```{r}
p1 <- p + 
  coord_polar()
```


```{r}
p1
```

  이를 Pie plot으로 변환하려면 coord_polar의 theta옵션을 “y”로 주면 된다. <br>

```{r}
p1 <- p + 
  coord_polar(theta = "y") 
p1
```

  이 그래프를 Donut plot으로 바꾸는 것은 x축의 좌표의 범위만 바꾸어 주면 된다. <br>
  
```{r}
p1 <- p +
  coord_polar(theta = "y") +
  xlim(0,4)
p1
```

  범례와 불필요한 축을 없애고, 대신 browser version을 각 모형에 표시하면 다음과 같다.

```{r}
p2 <- p1 + 
  geom_text(aes(x=3.5,y=ypos+1,label=version))+
  guides(fill=FALSE) + 
  theme(axis.title = element_blank(),       # 축 타이틀 삭제
        axis.text = element_blank(),        # 축 텍스트 삭제 
        axis.ticks = element_blank(),       # 축 ticks  삭제
        panel.background = element_blank(), # 패널 배경 삭제 
        legend.position = "neon"            # 범례삭제
        )

p2
```

  다음으로 Donut plot에 Pie plot을 다음과 같이 결합할 수 있다. 먼저 pie plot을 그리기 위한 데이타 전처리가 필요하다. 
  
```{r}
data2 <- data1 %>%  
  group_by(browser) %>% 
  summarise_each(list(sum), sum = share) %>% 
  arrange(desc(sum)) %>%
  mutate(cumsum = cumsum(sum),
         pos = cumsum - (sum/2),
         ymin = cumsum - sum,
         ratio = sum/sum(sum)*100)
```

  이제 이렇게 만들어진 data2를 이용하여 기존의 plot에 파이그래프를 덧그린다. <br>
  
```{r}
p3 <- p2 + 
  geom_rect(data=data2, aes(xmin=0, xmax=3, ymin=ymin, ymax=cumsum,fill=browser, alpha=0.7)) +
  geom_text(data=data2, aes(x=1.5, y=pos, label=browser))
p3
```

  <br><br>
  

        
  




